---
import { MENTAL_MODELS_STARTER_QUESTIONS } from '../../data/mental-models';
---

<div id="models-chat-container" class="flex flex-col h-[600px] bg-zinc-900 rounded-lg border border-zinc-800 overflow-hidden">
  <!-- Header -->
  <div class="px-6 py-4 border-b border-zinc-800 flex items-center gap-3">
    <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
    <div>
      <h3 class="font-medium text-zinc-50">Mental Models Coach</h3>
      <p class="text-sm text-zinc-500">122 frameworks to help you think better</p>
    </div>
  </div>

  <!-- Messages -->
  <div id="models-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
    <!-- Welcome message -->
    <div class="flex gap-3">
      <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-sm font-medium text-white shrink-0">
        M
      </div>
      <div class="bg-zinc-800 rounded-lg px-4 py-3 max-w-[80%]">
        <p class="text-zinc-300">
          I'm your Mental Models Coach. I can help you:
        </p>
        <ul class="text-zinc-400 text-sm mt-2 space-y-1">
          <li>• <strong>Analyze situations</strong> - tell me what you're facing</li>
          <li>• <strong>Think through decisions</strong> - I'll apply multiple lenses</li>
          <li>• <strong>Learn frameworks</strong> - ask me to explain any model</li>
          <li>• <strong>Find the right model</strong> - describe your problem</li>
        </ul>
        <p class="text-zinc-300 mt-3">What's on your mind?</p>
      </div>
    </div>

    <!-- Starter questions -->
    <div id="models-starters" class="flex flex-wrap gap-2 mt-4">
      {MENTAL_MODELS_STARTER_QUESTIONS.map((q) => (
        <button
          class="models-starter-btn px-3 py-2 text-sm text-zinc-400 bg-zinc-800 hover:bg-zinc-700 hover:text-zinc-50 rounded-lg transition-colors text-left"
          data-question={q}
        >
          {q}
        </button>
      ))}
    </div>
  </div>

  <!-- Input -->
  <div class="p-4 border-t border-zinc-800">
    <form id="models-chat-form" class="flex gap-3">
      <input
        type="text"
        id="models-chat-input"
        placeholder="Describe a situation or ask about a framework..."
        class="flex-1 px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-lg text-zinc-50 placeholder-zinc-500 focus:outline-none focus:border-emerald-500 transition-colors"
        autocomplete="off"
      />
      <button
        type="submit"
        id="models-send-btn"
        class="px-6 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Send
      </button>
    </form>
    <p class="mt-2 text-xs text-zinc-600 text-center">
      Powered by Claude. 9 original frameworks + 113 from Farnam Street.
    </p>
  </div>
</div>

<script>
  const messagesContainer = document.getElementById('models-messages');
  const chatForm = document.getElementById('models-chat-form') as HTMLFormElement;
  const chatInput = document.getElementById('models-chat-input') as HTMLInputElement;
  const sendBtn = document.getElementById('models-send-btn') as HTMLButtonElement;
  const startersContainer = document.getElementById('models-starters');

  let conversationHistory: Array<{role: string, content: string}> = [];

  // Handle starter question clicks
  document.querySelectorAll('.models-starter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const question = (e.target as HTMLElement).dataset.question;
      if (question) {
        chatInput.value = question;
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  });

  // Add message to UI
  function addMessage(content: string, isUser: boolean) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`;

    const avatar = document.createElement('div');
    avatar.className = `w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium text-white shrink-0 ${isUser ? 'bg-zinc-600' : 'bg-emerald-600'}`;
    avatar.textContent = isUser ? 'You' : 'M';

    const bubble = document.createElement('div');
    bubble.className = `rounded-lg px-4 py-3 max-w-[80%] ${isUser ? 'bg-emerald-600 text-white' : 'bg-zinc-800 text-zinc-300'}`;

    // Simple markdown-like formatting
    let formatted = content
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');
    bubble.innerHTML = formatted;

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(bubble);
    messagesContainer?.appendChild(messageDiv);

    // Scroll to bottom
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  // Add loading indicator
  function addLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'models-loading';
    loadingDiv.className = 'flex gap-3';
    loadingDiv.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-sm font-medium text-white shrink-0">M</div>
      <div class="bg-zinc-800 rounded-lg px-4 py-3">
        <div class="flex gap-1">
          <div class="w-2 h-2 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
          <div class="w-2 h-2 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
          <div class="w-2 h-2 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
      </div>
    `;
    messagesContainer?.appendChild(loadingDiv);
    messagesContainer?.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
  }

  function removeLoading() {
    document.getElementById('models-loading')?.remove();
  }

  // Handle form submit
  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = chatInput.value.trim();
    if (!message) return;

    // Hide starters after first message
    if (startersContainer) {
      startersContainer.style.display = 'none';
    }

    // Add user message
    addMessage(message, true);
    conversationHistory.push({ role: 'user', content: message });

    // Clear input and disable
    chatInput.value = '';
    sendBtn.disabled = true;
    chatInput.disabled = true;

    // Show loading
    addLoading();

    try {
      const response = await fetch('/api/models-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          history: conversationHistory.slice(-10) // Keep last 10 messages for context
        }),
      });

      if (!response.ok) throw new Error('Failed to get response');

      const data = await response.json();
      removeLoading();
      addMessage(data.response, false);
      conversationHistory.push({ role: 'assistant', content: data.response });

    } catch (error) {
      removeLoading();
      addMessage("Sorry, I'm having trouble connecting right now. Please try again.", false);
    } finally {
      sendBtn.disabled = false;
      chatInput.disabled = false;
      chatInput.focus();
    }
  });
</script>
